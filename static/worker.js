(()=>{"use strict";class e{static read_bytes(t,r){let s=new e;return s.buf=t.getUint32(r,!0),s.buf_len=t.getUint32(r+4,!0),s}static read_bytes_array(t,r,s){let n=[];for(let f=0;f<s;f++)n.push(e.read_bytes(t,r+8*f));return n}}class t{static read_bytes(e,r){let s=new t;return s.buf=e.getUint32(r,!0),s.buf_len=e.getUint32(r+4,!0),s}static read_bytes_array(e,r,s){let n=[];for(let f=0;f<s;f++)n.push(t.read_bytes(e,r+8*f));return n}}class r{args=[];env=[];fds=[];inst;wasiImport;start(e){this.inst=e,e.exports._start()}constructor(r,s,n){this.args=r,this.env=s,this.fds=n;let f=this;this.wasiImport={args_sizes_get(e,t){let r=new DataView(f.inst.exports.memory.buffer);r.setUint32(e,f.args.length,!0);let s=0;for(let e of f.args)s+=e.length+1;return r.setUint32(t,s,!0),0},args_get(e,t){let r=new DataView(f.inst.exports.memory.buffer),s=new Uint8Array(f.inst.exports.memory.buffer);for(let n=0;n<f.args.length;n++){r.setUint32(e,t,!0),e+=4;let i=new TextEncoder("utf-8").encode(f.args[n]);s.set(i,t),r.setUint8(t+i.length,0),t+=i.length+1}return 0},environ_sizes_get(e,t){let r=new DataView(f.inst.exports.memory.buffer);r.setUint32(e,f.env.length,!0);let s=0;for(let e of f.env)s+=e.length+1;return r.setUint32(t,s,!0),0},environ_get(e,t){let r=new DataView(f.inst.exports.memory.buffer),n=new Uint8Array(f.inst.exports.memory.buffer);for(let f=0;f<s.length;f++){r.setUint32(e,t,!0),e+=4;let i=new TextEncoder("utf-8").encode(s[f]);n.set(i,t),r.setUint8(t+i.length,0),t+=i.length+1}return 0},clock_res_get(e,t){throw"unimplemented"},clock_time_get(e,t,r){let s=new DataView(f.inst.exports.memory.buffer);return 0===e?s.setBigUint64(r,1000000n*BigInt((new Date).getTime()),!0):s.setBigUint64(r,0n,!0),0},fd_advise:(e,t,r,s)=>null!=f.fds[e]?f.fds[e].fd_advise(t,r,s):8,fd_allocate:(e,t,r)=>null!=f.fds[e]?f.fds[e].fd_allocate(t,r):8,fd_close(e){if(null!=f.fds[e]){let t=f.fds[e].fd_close();return f.fds[e]=void 0,t}return 8},fd_datasync:e=>null!=f.fds[e]?f.fds[e].fd_datasync():8,fd_fdstat_get(e,t){if(null!=f.fds[e]){let{ret:r,fdstat:s}=f.fds[e].fd_fdstat_get();return null!=s&&s.write_bytes(new DataView(f.inst.exports.memory.buffer),t),r}return 8},fd_fdstat_set_flags:(e,t)=>null!=f.fds[e]?f.fds[e].fd_fdstat_set_flags(t):8,fd_fdstat_set_rights:(e,t,r)=>null!=f.fds[e]?f.fds[e].fd_fdstat_set_rights(t,r):8,fd_filestat_get(e,t){if(null!=f.fds[e]){let{ret:r,filestat:s}=f.fds[e].fd_filestat_get();return null!=s&&s.write_bytes(new DataView(f.inst.exports.memory.buffer),t),r}return 8},fd_filestat_set_size:(e,t)=>null!=f.fds[e]?f.fds[e].fd_filestat_set_size(t):8,fd_filestat_set_times:(e,t,r,s)=>null!=f.fds[e]?f.fds[e].fd_filestat_set_times(t,r,s):8,fd_pread(t,r,s,n,i){let l=new DataView(f.inst.exports.memory.buffer),a=new Uint8Array(f.inst.exports.memory.buffer);if(null!=f.fds[t]){let d=e.read_bytes_array(l,r,s),{ret:o,nread:u}=f.fds[t].fd_pread(a,d,n);return l.setUint32(i,u,!0),o}return 8},fd_prestat_get(e,t){let r=new DataView(f.inst.exports.memory.buffer);if(null!=f.fds[e]){let{ret:s,prestat:n}=f.fds[e].fd_prestat_get();return null!=n&&n.write_bytes(r,t),s}return 8},fd_prestat_dir_name(e,t,r){if(null!=f.fds[e]){let{ret:r,prestat_dir_name:s}=f.fds[e].fd_prestat_dir_name();return null!=s&&new Uint8Array(f.inst.exports.memory.buffer).set(s,t),r}return 8},fd_pwrite(e,r,s,n,i){let l=new DataView(f.inst.exports.memory.buffer),a=new Uint8Array(f.inst.exports.memory.buffer);if(null!=f.fds[e]){let d=t.read_bytes_array(l,r,s),{ret:o,nwritten:u}=f.fds[e].fd_pwrite(a,d,n);return l.setUint32(i,u,!0),o}return 8},fd_read(t,r,s,n){let i=new DataView(f.inst.exports.memory.buffer),l=new Uint8Array(f.inst.exports.memory.buffer);if(null!=f.fds[t]){let a=e.read_bytes_array(i,r,s),{ret:d,nread:o}=f.fds[t].fd_read(l,a);return i.setUint32(n,o,!0),d}return 8},fd_readdir(e,t,r,s,n){let i=new DataView(f.inst.exports.memory.buffer),l=new Uint8Array(f.inst.exports.memory.buffer);if(null!=f.fds[e]){let a=0;for(;;){let{ret:d,dirent:o}=f.fds[e].fd_readdir_single(s);if(0!=d)return i.setUint32(n,a,!0),d;if(null==o)break;let u=o.length();if(r-a<u)break;o.write_bytes(i,l,t),t+=u,a+=u,s=o.d_next}return i.setUint32(n,a,!0),0}return 8},fd_renumber(e,t){if(null!=f.fds[e]&&null!=f.fds[t]){let r=f.fds[t].fd_close();return 0!=r?r:(f.fds[t]=f.fds[e],f.fds[e]=void 0,0)}return 8},fd_seek(e,t,r,s){let n=new DataView(f.inst.exports.memory.buffer);if(null!=f.fds[e]){let{ret:i,offset_out:l}=f.fds[e].fd_seek(t,r);return n.setUint32(s,l,!0),i}return 8},fd_sync:e=>null!=f.fds[e]?f.fds[e].fd_sync():8,fd_tell(e,t){let r=new DataView(f.inst.exports.memory.buffer);if(null!=f.fds[e]){let{ret:s,offset:n}=f.fds[e].fd_tell();return r.setUint32(t,n,!0),s}return 8},fd_write(e,r,s,n){let i=new DataView(f.inst.exports.memory.buffer),l=new Uint8Array(f.inst.exports.memory.buffer);if(null!=f.fds[e]){let a=t.read_bytes_array(i,r,s),{ret:d,nwritten:o}=f.fds[e].fd_write(l,a);return i.setUint32(n,o,!0),d}return 8},path_create_directory(e,t,r){let s=new Uint8Array(f.inst.exports.memory.buffer);if(null!=f.fds[e]){let n=new TextDecoder("utf-8").decode(s.slice(t,t+r));return f.fds[e].path_create_directory(n)}},path_filestat_get(e,t,r,s,n){let i=new DataView(f.inst.exports.memory.buffer),l=new Uint8Array(f.inst.exports.memory.buffer);if(null!=f.fds[e]){let a=new TextDecoder("utf-8").decode(l.slice(r,r+s)),{ret:d,filestat:o}=f.fds[e].path_filestat_get(t,a);return null!=o&&o.write_bytes(i,n),d}return 8},path_filestat_set_times(e,t,r,s,n,i,l){let a=new Uint8Array(f.inst.exports.memory.buffer);if(null!=f.fds[e]){let d=new TextDecoder("utf-8").decode(a.slice(r,r+s));return f.fds[e].path_filestat_set_times(t,d,n,i,l)}return 8},path_link(e,t,r,s,n,i,l){let a=new Uint8Array(f.inst.exports.memory.buffer);if(null!=f.fds[e]&&null!=f.fds[n]){let d=new TextDecoder("utf-8").decode(a.slice(r,r+s)),o=new TextDecoder("utf-8").decode(a.slice(i,i+l));return f.fds[n].path_link(e,t,d,o)}return 8},path_open(e,t,r,s,n,i,l,a,d){let o=new DataView(f.inst.exports.memory.buffer),u=new Uint8Array(f.inst.exports.memory.buffer);if(null!=f.fds[e]){let _=new TextDecoder("utf-8").decode(u.slice(r,r+s)),{ret:m,fd_obj:w}=f.fds[e].path_open(t,_,n,i,l,a);if(0!=m)return m;f.fds.push(w);let y=f.fds.length-1;return o.setUint32(d,y,!0),0}return 8},path_readlink(e,t,r,s,n,i){let l=new DataView(f.inst.exports.memory.buffer),a=new Uint8Array(f.inst.exports.memory.buffer);if(null!=f.fds[e]){let d=new TextDecoder("utf-8").decode(a.slice(t,t+r)),{ret:o,data:u}=f.fds[e].path_readlink(d);if(null!=u){if(u.length>n)return l.setUint32(i,0,!0),8;a.set(u,s),l.setUint32(i,u.length,!0)}return o}return 8},path_remove_directory(e,t,r){let s=new Uint8Array(f.inst.exports.memory.buffer);if(null!=f.fds[e]){let n=new TextDecoder("utf-8").decode(s.slice(t,t+r));return f.fds[e].path_remove_directory(n)}return 8},path_rename(e,t,r,s,n,f){throw"FIXME what is the best abstraction for this?"},path_symlink(e,t,r,s,n){let i=new Uint8Array(f.inst.exports.memory.buffer);if(null!=f.fds[r]){let l=new TextDecoder("utf-8").decode(i.slice(e,e+t)),a=new TextDecoder("utf-8").decode(i.slice(s,s+n));return f.fds[r].path_symlink(l,a)}return 8},path_unlink_file(e,t,r){let s=new Uint8Array(f.inst.exports.memory.buffer);if(null!=f.fds[e]){let n=new TextDecoder("utf-8").decode(s.slice(t,t+r));return f.fds[e].path_unlink_file(n)}return 8},poll_oneoff(e,t,r){throw"async io not supported"},proc_exit(e){throw"exit with exit code "+e},proc_raise(e){throw"raised signal "+e},sched_yield(){},random_get(e,t){let r=new Uint8Array(f.inst.exports.memory.buffer);for(let s=0;s<t;s++)r[e+s]=256*Math.random()|0},sock_recv(e,t,r){throw"sockets not supported"},sock_send(e,t,r){throw"sockets not supported"},sock_shutdown(e,t){throw"sockets not supported"}}}}const s=new TextEncoder,n=new TextDecoder;async function f(e){const t=new r([],[],[]),s=await WebAssembly.instantiateStreaming(e,{wasi_snapshot_preview1:t.wasiImport});return t.inst=s.instance,s}!async function(){const[e,t]=await Promise.all([f(fetch("/static/fourmolu-wasm.wasm")),fetch("/static/hackage-info.bin").then((e=>e.arrayBuffer()))]),r=e.instance.exports,i=(e,t)=>{const s=e.byteLength,n=r.malloc(s);try{new Uint8Array(r.memory.buffer,n,s).set(e),t(n,s)}finally{r.free(n)}};r._initialize(),r.hs_init(0,0),i(t,r.initFixityDB),self.onmessage=e=>{const t=s.encode(e.data);i(t,((s,f)=>{const i=r.runFourmolu(s,f);console.log({buffer:r.memory.buffer,inputPtr:s,inputLen:f,inputBytes:t,input:e.data});try{const e=r.getString(i),t=r.getStringLen(i),s=new Uint8Array(r.memory.buffer,e,t),f=n.decode(s);console.log({buffer:r.memory.buffer,resultPtr:i,outputPtr:e,outputLen:t,outputBytes:s,output:f}),self.postMessage(f)}finally{r.freeStringWithLen(i)}}))},self.postMessage(null)}()})();